# Chemistry 未完成功能分阶段实现计划

## 1. 目标与范围

本计划针对 `docs/chemistry.md` 中当前尚未完整落地的能力，分阶段补齐：

1. 分子识别精度（拓扑识别，避免误判）
2. 稳定性评分中的角度扭曲项
3. 键旋转交互（单键可旋转，双/三键受限）
4. 极性计算（键极性 + 分子几何合成）
5. 识别后的结构式与分子知识展示
6. Atom/Bond 数据抽象补全（electronegativity、rotatable、bondEnergy 等）

不在本轮范围（后续扩展）：共振、杂化轨道、形式电荷、立体异构。

---

## 2. 实施原则

1. 测试先行（TDD）：每个阶段先补测试再改实现。
2. 渐进演进：优先保持现有 UI/交互稳定，避免一次性大重构。
3. 向后兼容：旧状态数据可迁移或有默认值回退。
4. 最小可用：每阶段都可独立验收并上线。

---

## 3. 分阶段计划

## 阶段 0：基线与测试护栏（0.5 天）

目标：建立后续改造的回归保护。

交付：

1. 新增 `chemistry` 相关测试骨架（识别、稳定性、极性、旋转规则）。
2. 增加关键场景快照数据（H2O, CH4, NH3, CO2, 反例拓扑）。

建议文件：

1. `src/identifier.test.ts`（扩展）
2. `src/stability.test.ts`（扩展）
3. `src/physics` 或 `src/rotation` 新增测试文件
4. `src/polarity.test.ts`（新增）

验收标准：

1. 测试可以在当前实现下运行并明确暴露待实现失败用例（允许阶段内红灯）。

---

## 阶段 1：分子识别引擎升级（1-1.5 天）

目标：从“计数匹配”升级为“拓扑 + 键阶匹配”，消除误判并稳定挑战模式。

交付：

1. 定义分子图表示（节点元素 + 边键阶）。
2. 为已知分子建立规范模板（可从 `KNOWN_MOLECULES` 演进）。
3. 实现图同构/规范签名匹配（优先签名法，必要时回溯匹配）。
4. `identifyMolecule` 输出结构标识（为后续结构式展示做准备）。

测试（先写）：

1. 同元素计数但不同连接方式的反例必须区分。
2. 同分子不同原子添加顺序应识别一致。
3. 现有已支持分子全部通过。

验收标准：

1. 识别误判用例全部消失。
2. 挑战模式胜利判定仅在真实拓扑匹配时触发。

---

## 阶段 2：数据模型补全与迁移（1 天）

目标：让 Atom/Bond 数据结构支持化学计算与交互约束。

交付：

1. 扩展元素元数据：`electronegativity`、`covalentRadius`、`vdwRadius`、`maxBonds`。
2. 扩展 `Bond`：`bondEnergy`、`rotatable`、`bondLength`（可计算字段或持久字段，二选一并统一）。
3. 若字段持久化到 store，补齐默认值与兼容逻辑。

测试（先写）：

1. 新字段默认值正确。
2. 单/双/三键 `rotatable` 规则正确。
3. 旧状态数据导入不会崩溃（如适用）。

验收标准：

1. 所有核心化学计算不再依赖硬编码散落逻辑。
2. 类型检查通过且无 `any` 回退。

---

## 阶段 3：稳定性评分二期（角度扭曲）（1-1.5 天）

目标：将几何合理性纳入稳定度。

交付：

1. 引入“理想角 vs 实际角”偏差惩罚（按中心原子局部域统计）。
2. 将扭曲能量并入总能量/分数，形成可解释 issue 文案。
3. UI 中显示角度相关问题（本地化先复用英文模板，后续补翻译）。

测试（先写）：

1. 理想几何（如 CO2 线型）得分高于明显扭曲构型。
2. 角度惩罚与价数惩罚可叠加。
3. 不应对原子不足（<3 点）场景引入虚假惩罚。

验收标准：

1. 稳定性评估同时覆盖：价数、键能、几何角度。

---

## 阶段 4：键旋转交互与约束（1-2 天）

目标：支持“单键可旋转、双/三键受限”的教学交互。

交付：

1. 新增键选中与旋转模式（鼠标拖拽/触控手势二选一先落地）。
2. 单键旋转：围绕键轴旋转一侧子图。
3. 双/三键旋转：禁止或强阻尼（给出视觉反馈）。
4. 与现有拖拽原子、OrbitControls 协调避免冲突。

测试（先写）：

1. 单键旋转会改变相关原子坐标且保持键长近似不变。
2. 双键旋转输入不会改变拓扑构型。
3. 删除模式与旋转模式互斥行为正确。

验收标准：

1. 旋转交互稳定，无明显抖动或相机抢控制。

---

## 阶段 5：极性计算 + 展示增强（1-1.5 天）

目标：完成文档中的进阶教学闭环。

交付：

1. 键极性：基于电负性差计算局部偶极方向/强度。
2. 分子极性：合成全分子偶极（向量和 + 几何对称性判定）。
3. UI 新增展示：`Polar / Nonpolar` 与简要原因。
4. 识别后展示结构式（最小版本：文本结构式）与知识卡片（短描述）。

测试（先写）：

1. CO2 判为非极性、H2O 判为极性。
2. 对称分子偶极近零，非对称分子偶极显著非零。
3. 未识别分子也可给出可计算的极性结果（或明确“信息不足”）。

验收标准：

1. 已识别分子可展示：名称、分子式、结构式、极性、小知识。

---

## 4. 建议任务拆分（PR 粒度）

1. PR-1: 阶段 0 + 阶段 1（识别引擎）
2. PR-2: 阶段 2（数据模型补全）
3. PR-3: 阶段 3（稳定性二期）
4. PR-4: 阶段 4（键旋转）
5. PR-5: 阶段 5（极性 + 展示）

每个 PR 要求：

1. `npm run test`
2. `npm run lint`
3. `npm run build`
4. 手动验证录屏（关键交互）

---

## 5. 风险与缓解

1. 图同构复杂度风险：先用规范签名 + 小分子规模限制，必要时再上回溯。
2. 旋转与物理引擎冲突：引入交互锁与短时冻结，避免双重驱动。
3. 极性与几何噪声：对瞬时坐标做轻量平滑或采样平均。
4. UI 复杂度上升：先做“信息卡片”最小版本，再迭代视觉层。

---

## 6. 完成定义（Definition of Done）

1. `docs/chemistry.md` 中本计划覆盖的未完成项均有实现或明确降级说明。
2. 所有新增能力有对应自动化测试。
3. 功能与性能可在现有设备下流畅运行。
4. 文档同步更新：用户操作说明 + 开发说明 + 已知限制。
